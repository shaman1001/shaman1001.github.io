<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pörssisähkön Hinta</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#fff; color:#333; margin:0; padding:20px; display:flex; justify-content:center; }
        .container { max-width:800px; width:100%; padding:25px; border:2px solid #003580; border-radius:6px; text-align:center; background:#fff; }
        h1 { color:#003580; margin:0 0 8px 0; text-transform:uppercase; }
        .current-price-box { background:#003580; color:#fff; padding:18px; border-radius:8px; display:inline-block; margin-bottom:18px; }
        .price-value { font-size:2.5rem; font-weight:700; }
        .chart-container { position:relative; height:400px; width:100%; margin-top:12px; }
        .loading { font-style:italic; color:#888; }
        .footer-info { margin-top:14px; font-size:0.85rem; color:#666; }
    </style>
</head>
<body>
<div class="container">
    <h1>Pörssisähkö</h1>
    <p class="subtitle">Hinnat sisältävät ALV:n (Prices incl. VAT)</p>

    <div class="current-price-box">
        <div>Hinta Nyt</div>
        <div id="currentPrice" class="price-value">--</div>
        <div class="price-unit">snt / kWh</div>
    </div>

    <div class="chart-container">
        <canvas id="priceChart"></canvas>
    </div>

    <p id="statusMessage" class="loading">Ladataan...</p>

    <div class="footer-info">Päivitetty: <span id="lastUpdated">--:--</span></div>
</div>

<script>
let priceChartInstance = null;

async function fetchPrices() {
    const statusMsg = document.getElementById('statusMessage');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    statusMsg.style.color = '#888';
    statusMsg.innerText = 'Ladataan...';
    statusMsg.style.display = 'block';

    try {
        const url = 'https://api.porssisahko.net/v2/latest-prices.json';
        console.log('Hakemassa:', url);

        const response = await fetch(url, { cache: 'no-store' });
        if (!response.ok) {
            // Lue myös response-teksti debugia varten
            const txt = await response.text();
            throw new Error(`HTTP ${response.status} - ${response.statusText}\nVastaus: ${txt}`);
        }

        // yritä parsia JSON
        const data = await response.json();
        console.log('API raw data:', data);

        // varmista, että data.prices on olemassa ja on taulukko
        if (!data || !Array.isArray(data.prices)) {
            throw new Error('JSON ei sisällä odotettua "prices"-taulukkoa. Katso konsolista raw data.');
        }

        let prices = data.prices.slice(); // kopio
        // Jos API antaa uusimman ensin, voi kääntää. Ota pois kommentti tarvittaessa:
        // prices.reverse();

        // Prepare structs
        const labels = [];
        const dataPoints = [];
        let currentPrice = null;
        const now = new Date();

        // Suodatus: oletuksena viimeiset 24 tuntia (helpompi testata),
        // voit muuttaa 24 -> 2 jos haluat vain 2 tunnin dataa.
        const lookbackMillis = 24 * 60 * 60 * 1000; // 24 tuntia
        // const lookbackMillis = 2 * 60 * 60 * 1000; // 2 tuntia (palauta tarvittaessa)

        prices.forEach(entry => {
            // Tulostetaan entry konsoliin, jotta näkee avaimet
            // console.log(entry);

            // Tiedoston kenttänimet voivat olla esim. startDate / endDate / price tai jotain muuta.
            // Yritetään hakea kentät usealla mahdollisella nimellä:
            const startRaw = entry.startDate ?? entry.start ?? entry.start_time ?? entry.from;
            const endRaw =

